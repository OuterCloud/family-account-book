name: CI - å®¶åº­è´¦æœ¬åº”ç”¨

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.11, 3.12, 3.13]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-xfixes0

      - name: ç¼“å­˜ä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ä»£ç é£æ ¼æ£€æŸ¥
        run: |
          pip install black isort flake8
          # æ£€æŸ¥ä»£ç æ ¼å¼
          black --check --diff family_account_book/
          # æ£€æŸ¥å¯¼å…¥æ’åº
          isort --check-only --diff family_account_book/
          # ä»£ç è´¨é‡æ£€æŸ¥
          flake8 family_account_book/ --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: |
          export QT_QPA_PLATFORM=offscreen
          export DISPLAY=:99.0
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
          sleep 3
          python -m pytest tests/ -v --tb=short

      - name: ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
        run: |
          pip install pytest-cov
          export QT_QPA_PLATFORM=offscreen
          export DISPLAY=:99.0
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
          sleep 3
          python -m pytest tests/ --cov=family_account_book --cov-report=xml --cov-report=html

      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Šåˆ° Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  build-macos:
    runs-on: macos-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python 3.13
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: æ„å»º macOS åº”ç”¨
        run: |
          chmod +x build_app.sh
          ./build_app.sh

      - name: æµ‹è¯•æ„å»ºç»“æœ
        run: |
          ls -la dist/
          # æ£€æŸ¥åº”ç”¨æ˜¯å¦æˆåŠŸåˆ›å»º
          test -d "dist/å®¶åº­è´¦æœ¬.app"
          echo "âœ… macOS åº”ç”¨æ„å»ºæˆåŠŸ"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: family-account-book-macos
          path: dist/å®¶åº­è´¦æœ¬.app
          retention-days: 30

      - name: è®¡ç®—æ–‡ä»¶å¤§å°
        run: |
          APP_SIZE=$(du -sh "dist/å®¶åº­è´¦æœ¬.app" | cut -f1)
          echo "ğŸ“¦ åº”ç”¨å¤§å°: $APP_SIZE"
          echo "APP_SIZE=$APP_SIZE" >> $GITHUB_ENV

  notify:
    runs-on: ubuntu-latest
    needs: [test, build-macos]
    if: always()

    steps:
      - name: æ„å»ºçŠ¶æ€é€šçŸ¥
        run: |
          if [ "${{ needs.test.result }}" = "success" ] && [ "${{ needs.build-macos.result }}" = "success" ]; then
            echo "âœ… CI æµç¨‹å…¨éƒ¨æˆåŠŸå®Œæˆ"
            echo "ğŸ§ª æµ‹è¯•é€šè¿‡"
            echo "ğŸ“¦ macOS åº”ç”¨æ„å»ºæˆåŠŸ"
          elif [ "${{ needs.test.result }}" = "failure" ]; then
            echo "âŒ æµ‹è¯•å¤±è´¥"
            exit 1
          elif [ "${{ needs.build-macos.result }}" = "failure" ]; then
            echo "âŒ macOS åº”ç”¨æ„å»ºå¤±è´¥"
            exit 1
          else
            echo "âš ï¸  CI æµç¨‹éƒ¨åˆ†å¤±è´¥"
            exit 1
          fi
